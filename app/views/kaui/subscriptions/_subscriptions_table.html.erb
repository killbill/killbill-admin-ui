<table id="subscriptions_<%= bundle.bundle_id %>" class="subscriptions-table">
  <thead>
  <tr>
    <% unless @available_subscription_tags.blank? && @custom_fields_per_subscription.blank? %>
      <th></th>
    <% end %> 
    <th class="sortable-header" data-column="<%= (@available_subscription_tags.blank? && @custom_fields_per_subscription.blank?) ? 0 : 1 %>">
      <div class="header-content">
        <span class="header-text">Name</span>
        <div class="sort-icons">
          <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
          <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
        </div>
      </div>
    </th>
    <th class="sortable-header" data-column="<%= (@available_subscription_tags.blank? && @custom_fields_per_subscription.blank?) ? 1 : 2 %>">
      <div class="header-content">
        <span class="header-text">Category</span>
        <div class="sort-icons">
          <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
          <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
        </div>
      </div>
    </th>
    <th class="sortable-header" data-column="<%= (@available_subscription_tags.blank? && @custom_fields_per_subscription.blank?) ? 2 : 3 %>">
      <div class="header-content">
        <span class="header-text">Phase type</span>
        <div class="sort-icons">
          <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
          <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
        </div>
      </div>
    </th>
    <th class="sortable-header" data-column="<%= (@available_subscription_tags.blank? && @custom_fields_per_subscription.blank?) ? 3 : 4 %>">
      <div class="header-content">
        <span class="header-text">Start date</span>
        <div class="sort-icons">
          <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
          <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
        </div>
      </div>
    </th>
    <th class="sortable-header" data-column="<%= (@available_subscription_tags.blank? && @custom_fields_per_subscription.blank?) ? 4 : 5 %>">
      <div class="header-content">
        <span class="header-text">Cancel information</span>
        <div class="sort-icons">
          <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
          <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
        </div>
      </div>
    </th>
    <th class="sortable-header" data-column="<%= (@available_subscription_tags.blank? && @custom_fields_per_subscription.blank?) ? 5 : 6 %>">
      <div class="header-content">
        <span class="header-text">Charged Date</span>
        <div class="sort-icons">
          <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
          <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
        </div>
      </div>
    </th>
    <th></th>
  </tr>
  </thead>
  <tbody>
    <% (bundle.subscriptions || []).each do |sub| %>
      <% dropdown_id = "cancelDropdown-#{sub.subscription_id}" %>
      <tr class="<%= subscription_cancelled?(sub) ? 'expired expired-row' : 'non-expired' %>">
        <% unless @available_subscription_tags.blank? && @custom_fields_per_subscription.blank? %> 
          <td class="full-visible">
            <div class="tag-bar tag-bar-no-border children-tag-bar">
              <% unless @available_subscription_tags.blank? %> 

                <div class="tag-select" onclick="void(0)">
                  <%= render "kaui/components/button/button", {
                    label: "",
                    trailing_icon: "kaui/sidebar/tags.svg", 
                    variant: "",
                    type: "button",
                    html_class: "kaui-button custom-hover dots-menu me-2",
                  } %>

                  <div class="tag-select-box tag-as-select-box d-flex flex-column align-items-start children-tag-select-box" style="opacity: 1;">
                    <strong>Tag As:</strong>
                    <%= render :partial => 'kaui/bundle_tags/form_bar',
                                :locals => {:params => { :bundle_id => bundle.bundle_id},
                                  :tag_names => (@tags_per_subscription[sub.subscription_id] || []).map { |tag| tag.tag_definition_name },
                                  :available_tags => @available_subscription_tags,
                                  :update_tags_path => update_subscriptions_tags_path(sub.subscription_id)
                                } %> 
                  </div>
                </div>
              <% end %> 

              <%= render :partial => 'kaui/custom_fields/list_bar', :locals => {:custom_fields => @custom_fields_per_subscription[sub.subscription_id] || []} %>
            </div>
          </td>
        <% end %>
        <td><%= humanized_subscription_plan_or_product_name(sub, catalog) %></td>
        <td>
          <span id="<%= sub.subscription_id %>-popover" class="object-id-popover category-bedge" data-id="<%= sub.subscription_id %>">
            <%= humanized_subscription_product_category(sub) %>
          </span>
        </td>
        <td><span class="phase-type"><%= humanized_subscription_phase_type(sub).downcase %></span></td>
        <td><%= humanized_subscription_start_date(sub, account) %></td>
        <td><%= humanized_subscription_cancelled_information(sub, account) %></td>
        <td><%= humanized_subscription_charged_through_date(sub, account) %></td>
        <td class="text-center">
          <% if subscription_future_cancelled?(sub, account) %>
            <%= link_to 'Reinstate', kaui_engine.reinstate_path(:id => sub.subscription_id), :method => :put, :class => 'btn btn-xs' %>
          <% elsif !subscription_cancelled?(sub) %>
            <div class="d-flex justify-content-end align-items-center">
              <% if can? :cancel, Kaui::Subscription %>
                <div class="btn-group cancel-menu position-relative" id="<%= dropdown_id %>Wrapper">
                  <button id="<%= dropdown_id %>Btn" class="cancel-button">
                    Cancel
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M4 6.00003L8.00002 10L12 6" stroke="#D92D20" stroke-width="1.5" stroke-miterlimit="16" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>

                  <ul class="dropdown-menu"
                      id="<%= dropdown_id %>Menu"
                      style="display: none;">
                    <li><%= link_to 'Cancel (default policy)', kaui_engine.subscription_path(id: sub.subscription_id), method: :delete %></li>
                    <li><%= link_to 'Cancel start of term (full credit)', kaui_engine.subscription_path(id: sub.subscription_id, policy: 'START_OF_TERM'), method: :delete %></li>
                    <li><%= link_to 'Cancel immediately (partial credit)', kaui_engine.subscription_path(id: sub.subscription_id, policy: 'IMMEDIATE'), method: :delete %></li>
                    <li><%= link_to 'Cancel end of term (no credit)', kaui_engine.subscription_path(id: sub.subscription_id, policy: 'END_OF_TERM'), method: :delete %></li>
                    <li><%= link_to 'Cancel a subscription given a date', '#cancel_subscription_by_date_modal', data: { bs_toggle: 'modal', id: sub.subscription_id } %></li>
                  </ul>
                </div>
              <% end %>

              <% if can?(:create, Kaui::Subscription) || can?(:pause_resume, Kaui::Subscription) || can?(:change_plan, Kaui::Subscription) %>
                <% menu_items = [] %>

                <% if can?(:change_plan, Kaui::Subscription) %>
                  <% menu_items << {
                    label: "Change Plan",
                    path: kaui_engine.edit_subscription_path(sub.subscription_id),
                    icon: "kaui/subscription/change.svg"
                  } %>
                <% end %>

                <% if can?(:create, Kaui::Subscription) && @subscription[bundle.bundle_id].present? %>
                  <% menu_items << {
                    label: @subscription[bundle.bundle_id].product_category == 'BASE' ? 'Add add-on' : 'Add standalone subscription',
                    path: kaui_engine.new_subscription_path(
                      params: {
                        account_id: bundle.account_id,
                        bundle_id: bundle.bundle_id,
                        base_product_name: @subscription[bundle.bundle_id].product_name,
                        product_category: @subscription[bundle.bundle_id].product_category == 'BASE' ? 'ADD_ON' : 'STANDALONE'
                      }
                    ),
                    icon: "kaui/subscription/add-on.svg"
                  } %>
                <% end %>

                <% if can?(:pause_resume, Kaui::Subscription) %>
                  <% menu_items << {
                    label: "Pause / resume",
                    path: kaui_engine.pause_resume_bundle_path(account_id: bundle.account_id, id: bundle.bundle_id),
                    icon: "kaui/subscription/pause.svg"
                  } %>
                <% end %>

                <% if can?(:create, Kaui::Subscription) %>
                  <% menu_items << {
                    label: "Update BCD",
                    path: kaui_engine.edit_bcd_path(id: sub.subscription_id),
                    icon: "kaui/subscription/date.svg"
                  } %>
                <% end %>

                <%= render partial: "kaui/components/menu_dropdown/menu_dropdown", locals: {
                    variant: "btn-light",
                    label: "",
                    icon: "kaui/dots.svg",
                    html_class: "dots-menu",
                    menu_items: menu_items,
                    dropdown_id: "dotsDropdown-#{sub.subscription_id}",
                } %>
              <% end %>
            </div>
          <% end %>

        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= render :partial => 'kaui/subscriptions/cancel_by_date_modal' %>

<%= javascript_tag do %>
  $(document).ready(function() {
    $('.subscription-id-popover').popover();

    var table = $('#subscriptions_<%= bundle.bundle_id %>').DataTable({
      "dom": "t",
      "paging": false,
      "order": [[ <%= @available_subscription_tags.blank? && @custom_fields_per_subscription.blank? ? 3 : 4 %>, "asc" ]],
      "columns": [
        <%= "{ orderable: false }," unless @available_subscription_tags.blank? && @custom_fields_per_subscription.blank? %>
        null,
        null,
        null,
        null,
        null,
        null,
        { "orderable": false }
      ],
      "drawCallback": function() {
        setObjectIdTooltip();
      }
    });

    // Custom sorting functionality for this table
    (function() {
      var currentSortColumn = <%= @available_subscription_tags.blank? && @custom_fields_per_subscription.blank? ? 3 : 4 %>;
      var currentSortDirection = 'asc';
      updateSortIndicators($('#subscriptions_<%= bundle.bundle_id %>'), currentSortColumn, currentSortDirection);

      $('#subscriptions_<%= bundle.bundle_id %> thead .sortable-header').on('click', function() {
        var columnIndex = parseInt($(this).data('column'));
        var newDirection = (currentSortColumn === columnIndex && currentSortDirection === 'asc') ? 'desc' : 'asc';
        currentSortColumn = columnIndex;
        currentSortDirection = newDirection;
        updateSortIndicators($('#subscriptions_<%= bundle.bundle_id %>'), columnIndex, newDirection);
        table.order([columnIndex, newDirection]).draw();
      });
    })();

    $(".price-override-popover").popover({
      container: 'body',
      trigger: 'hover'
    });

    document.querySelectorAll('.cancel-button').forEach(function(button) {
      const idPrefix = button.id.replace('Btn', '');
      const menu = document.getElementById(idPrefix + 'Menu');
      const wrapper = document.getElementById(idPrefix + 'Wrapper');

      button.addEventListener('click', function (e) {
        e.stopPropagation();

        // Close all open dropdowns first
        document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');

        // Toggle this one
        const isOpen = menu.style.display === 'block';
        menu.style.display = isOpen ? 'none' : 'block';
      });

      // Close dropdown on outside click
      document.addEventListener('click', function (e) {
        if (!wrapper.contains(e.target)) {
          menu.style.display = 'none';
        }
      });
    });
  });
  
  function updateSortIndicators($table, columnIndex, direction) {
    $table.find('.sortable-header').removeClass('sort-asc-active sort-desc-active');
    $table.find('.sort-icon').removeClass('active');
    var $header = $table.find('.sortable-header[data-column="' + columnIndex + '"]');
    $header.addClass(direction + '-active');
    $header.find('.sort-' + direction).addClass('active');
  }
<% end %>
