<%# Accept optional breadcrumbs array (e.g., passed via locals) %>
<% custom_breadcrumbs = local_assigns[:breadcrumbs] %>

<%# Improved dynamic root detection %>
<% 
  # Try to determine root path dynamically
  if request.path.start_with?('/kaui')
    dynamic_root = '/kaui'
  else
    dynamic_root = '/'
  end
%>

<% if custom_breadcrumbs.present? %>
<nav class="breadcrumb-nav" aria-label="Breadcrumb">
  <span class="breadcrumb-home">
      <%= link_to '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.33331 6.99994L7.16705 2.33295C7.65398 1.94338 8.34598 1.94338 8.83291 2.33295L14.6666 6.99994" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.66669 6V13C2.66669 13.7364 3.26364 14.3333 4.00002 14.3333H12C12.7364 14.3333 13.3334 13.7364 13.3334 13V6" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11.6667V12.3334" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/></svg>'.html_safe,
  dynamic_root, class: "breadcrumb-home" %>
  </span>
  <span class="breadcrumb-separator">/</span>
  <% custom_breadcrumbs.each_with_index do |item, index| %>
    <% is_last = index == custom_breadcrumbs.size - 1 %>

    <% if index > 0 %>
      <span class="breadcrumb-separator">/</span>
    <% end %>

    <% if is_last %>
      <span class="breadcrumb-current"><%= item[:label] %></span>
    <% else %>
      <% href = item[:href] == "/" ? dynamic_root : item[:href] %>
      <%= link_to item[:label], href, class: "breadcrumb-link" %>
    <% end %>
  <% end %>
</nav>
<% else %>
  <% full_path = request.fullpath.gsub(/\?.*/, '') %>
  <% segments = full_path.split("/").reject(&:blank?) %>

  <% if params[:account_id].present? && full_path.starts_with?("/kaui/queues") %>
    <% segments = ["kaui", "accounts", params[:account_id], "queues"] %>
  <% end %>

  <% segment_label_map = {
    'accounts' => 'Account',
    'bundles' => 'Subscriptions',
    'invoices' => 'Invoices',
    'payments' => 'Payments',
    'timelines' => 'Timeline',
    'account_tags' => 'Tags',
    'custom_fields' => 'Custom Fields',
    'queues' => 'Queues',
    'logs' => 'Audit',
    'payment_methods' => 'Payment Methods',
    'subscriptions' => 'Subscriptions',
    'credits' => 'Credits',
    'refunds' => 'Refunds',
    'chargebacks' => 'Chargebacks',
    'transactions' => 'Transactions',
    'admin' => 'Admin',
    'tenants' => 'Tenants',
    'home' => 'Dashboard'
  } %>

  <nav class="breadcrumb-nav" aria-label="Breadcrumb">
    <%# Always show home icon first %>
    <% if segments.empty? || (segments.size == 1 && segments.first == "kaui") %>
      <%# Home is the current/last page %>
      <span class="breadcrumb-home">
        <%= raw <<~SVG
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1.33331 6.99994L7.16705 2.33295C7.65398 1.94338 8.34598 1.94338 8.83291 2.33295L14.6666 6.99994" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2.66669 6V13C2.66669 13.7364 3.26364 14.3333 4.00002 14.3333H12C12.7364 14.3333 13.3334 13.7364 13.3334 13V6" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 11.6667V12.3334" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        SVG
        %>
      </span>
    <% else %>
      <%# Home is a link %>
      <%= link_to dynamic_root, class: "breadcrumb-home-link" do %>
        <%= raw <<~SVG
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1.33331 6.99994L7.16705 2.33295C7.65398 1.94338 8.34598 1.94338 8.83291 2.33295L14.6666 6.99994" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2.66669 6V13C2.66669 13.7364 3.26364 14.3333 4.00002 14.3333H12C12.7364 14.3333 13.3334 13.7364 13.3334 13V6" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 11.6667V12.3334" stroke="#A4A7AE" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        SVG
        %>
      <% end %>
    <% end %>

    <%# Process remaining segments (excluding root "kaui" segment) %>
    <% sanitized_segments = segments.map { |segment| CGI.escapeHTML(segment) } %>
    <% 
      # Skip the first segment if it's "kaui" since we already handled home
      display_segments = sanitized_segments.first == "kaui" ? sanitized_segments[1..-1] : sanitized_segments
    %>
    
    <% display_segments.each_with_index do |segment, index| %>
      <% is_last = index == display_segments.size - 1 %>
      <% 
        # Reconstruct path for this segment
        if sanitized_segments.first == "kaui"
          segment_path = "/" + (["kaui"] + display_segments[0..index]).join("/")
        else
          segment_path = "/" + display_segments[0..index].join("/")
        end
      %>

      <span class="breadcrumb-separator">/</span>

      <% if segment.match?(/\A[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\z/i)
          if defined?(@account) && @account&.account_id == segment
            label = @account.name.present? ? @account.name : "Account #{@account.account_id[0..7]}..."  
          elsif defined?(@payment) && @payment&.payment_id == segment
            label = @payment.payment_number.present? ? "Payment #{@payment.payment_number}" : "Payment #{@payment.payment_id[0..7]}..."
          elsif defined?(@invoice) && @invoice&.invoice_id == segment
            label = @invoice.invoice_number.present? ? "Invoice #{@invoice.invoice_number}" : "Invoice #{@invoice.invoice_id[0..7]}..."
          elsif defined?(@bundle) && @bundle&.bundle_id == segment
            label = @bundle.external_key.present? ? "Bundle #{@bundle.external_key}" : "Bundle #{@bundle.bundle_id[0..7]}..."
          elsif defined?(@subscription) && @subscription&.subscription_id == segment
            label = @subscription.external_key.present? ? "Subscription #{@subscription.external_key}" : "Subscription #{@subscription.subscription_id[0..7]}..."
          # Additional checks for common patterns using params
          elsif segment == params[:account_id] && defined?(@account)
            label = @account.name.present? ? @account.name : "Account #{@account.account_id[0..7]}..."
          elsif segment == params[:payment_id] && defined?(@payment)
            label = @payment.payment_number.present? ? "Payment #{@payment.payment_number}" : "Payment #{@payment.payment_id[0..7]}..."
          elsif segment == params[:invoice_id] && defined?(@invoice)
            label = @invoice.invoice_number.present? ? "Invoice #{@invoice.invoice_number}" : "Invoice #{@invoice.invoice_id[0..7]}..."
          else
            label = segment[0..7] + "..."
          end
        elsif segment_label_map[segment] %>
          <% label = segment_label_map[segment] %>
        <% else %>
          <% label = segment.titleize %>
        <% end %>
      <% if is_last %>
        <span class="breadcrumb-current"><%= label %></span>
      <% else %>
        <%= link_to label, CGI.escapeHTML(segment_path), class: "breadcrumb-link" %>
      <% end %>
    <% end %>
  </nav>
<% end %>
