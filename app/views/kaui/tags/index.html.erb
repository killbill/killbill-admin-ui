<div class="kaui-container kaui-tags-index">
  <%= render partial: 'kaui/components/breadcrumb/breadcrumb', locals: {
    breadcrumbs: [
      { label: 'Settings', href: '/' },
      { label: "Tags", href: '#' }
    ]
  } %>

  <div class="d-flex" style="gap: 4rem;">
    <%= render :template => 'kaui/layouts/kaui_setting_sidebar' %>

    <div class="tags-details w-100">
      <div class="d-flex flex-column">
        <div class="tags-details-header">
          <h2>Tags</h2>
          <span>
          </span>
        </div>

        <div class="mt-4 w-100">
         <table id="tags-table" class="tags-table">
          <thead>
          <tr>
            <th class="sortable-header" data-column="0">
              <div class="header-content">
                <span class="header-text">Tag ID</span>
                <div class="sort-icons">
                  <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
                  <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
                </div>
              </div>
            </th>
            <th class="sortable-header" data-column="1">
              <div class="header-content">
                <span class="header-text">Object ID</span>
                <div class="sort-icons">
                  <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
                  <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
                </div>
              </div>
            </th>
            <th class="sortable-header" data-column="2">
              <div class="header-content">
                <span class="header-text">Object type</span>
                <div class="sort-icons">
                  <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
                  <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
                </div>
              </div>
            </th>
            <th class="sortable-header" data-column="3">
              <div class="header-content">
                <span class="header-text">Tag definition name</span>
                <div class="sort-icons">
                  <%= image_tag "sort-up.svg", class: "sort-icon sort-asc" %>
                  <%= image_tag "sort-down.svg", class: "sort-icon sort-desc" %>
                </div>
              </div>
            </th>
          </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        </div>
      </div>
    </div>
  </div>
</div>

<%= javascript_tag do %>
  $(document).ready(function() {
    var table = $('#tags-table').DataTable({
      "dom": "<'row'<'col-md-6'l><'col-md-6'f>r>t<'row'<'col-md-6'i><'col-md-6'p>>",
      "pagingType": <% if @max_nb_records.nil? -%>"simple"<% else -%>"full_numbers"<% end -%>,
      "language": {
        "info": <% if @max_nb_records.nil? -%>"Showing _START_ to _END_ of <%= number_with_delimiter(Kaui::EngineControllerUtil::SIMPLE_PAGINATION_THRESHOLD) -%>+ entries"<% else -%>"Showing _START_ to _END_ of _TOTAL_ entries"<% end -%>
      },
      "pageLength": <%= @limit %>,
      "displayStart": <%= @offset %>,
      <% unless @ordering.blank? %>
        "order": [[ 0, "<%= @ordering %>" ]],
      <% end %>
      "processing": true,
      "serverSide": true,
      "search": {"search": "<%= @search_query %>"},
      "ajax": "<%= tags_pagination_path(:ordering => @ordering, :format => :json) %>"
    });

    // Custom sorting functionality
    var currentSortColumn = -1;
    var currentSortDirection = 'asc';

    // Handle custom header clicks
    $('.sortable-header').on('click', function() {
      var columnIndex = parseInt($(this).data('column'));
      var newDirection = 'asc';
      
      // If clicking the same column, toggle direction
      if (currentSortColumn === columnIndex) {
        newDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      }
      
      currentSortColumn = columnIndex;
      currentSortDirection = newDirection;
      
      // Update visual indicators
      updateSortIndicators(columnIndex, newDirection);
      
      // Apply DataTable sorting
      table.order([columnIndex, newDirection]).draw();
    });

    // Function to update sort indicators
    function updateSortIndicators(columnIndex, direction) {
      // Reset all headers
      $('.sortable-header').removeClass('sort-asc-active sort-desc-active');
      $('.sort-icon').removeClass('active');
      
      // Set active state for current column
      var $header = $('.sortable-header[data-column="' + columnIndex + '"]');
      $header.addClass(direction + '-active');
      $header.find('.sort-' + direction).addClass('active');
    }

    // Initialize sort indicators based on current state
    <% unless @ordering.blank? %>
      var initialColumn = 0;
      var initialDirection = "<%= @ordering %>";
      updateSortIndicators(initialColumn, initialDirection);
    <% end %>

    $('#tags-table').on('draw.dt', function() {
      // Custom logic for column 3 wrapping in a span
      $('#tags-table tbody tr').each(function () {
        const $td = $(this).find('td:nth-of-type(3)');
        const content = $td.text().trim();
        $td.html(`<span>${content}</span>`);
      });

      <% if @max_nb_records.nil? %>
        var noMoreData = table.column(0).data().length == 0;
        $(".next.paginate_button").toggleClass("disabled", noMoreData);
        $(".dataTables_info").toggle(!noMoreData);
      <% end %>
    });
  });
<% end %>
